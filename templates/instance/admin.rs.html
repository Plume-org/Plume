@use plume_models::instance::Instance;
@use plume_models::blogs::REMOTE_THEMES as themes;
@use validator::ValidationErrors;
@use templates::base;
@use template_utils::*;
@use routes::instance::InstanceSettingsForm;
@use routes::*;

@(ctx: BaseContext, instance: Instance, form: InstanceSettingsForm, errors: ValidationErrors)

@:base(ctx, i18n!(ctx.1, "Administration of {0}"; instance.name.clone()), {}, {}, {
  <h1>@i18n!(ctx.1, "Administration")</h1>

  @tabs(&[
    (&uri!(instance::admin).to_string(), i18n!(ctx.1, "Configuration"), true),
    (&uri!(instance::admin_instances: page = _).to_string(), i18n!(ctx.1, "Instances"), false),
    (&uri!(instance::admin_users: page = _).to_string(), i18n!(ctx.1, "Users"), false),
  ])

  <form method="post" action="@uri!(instance::update_settings)">
    @input!(ctx.1, name (text), "Name", form, errors.clone(), "props")

    <label for="open_registrations">
      <input type="checkbox" name="open_registrations" id="open_registrations" @if instance.open_registrations { checked }>
      @i18n!(ctx.1, "Allow anyone to register here")
    </label>

      <label for="short_description">@i18n!(ctx.1, "Short description")<small>@i18n!(ctx.1, "Markdown syntax is supported")</small></label>
      <textarea id="short_description" name="short_description">@Html(form.short_description)</textarea>

      <label for="long_description">@i18n!(ctx.1, "Long description")<small>@i18n!(ctx.1, "Markdown syntax is supported")</small></label>
      <textarea id="long_description" name="long_description">@Html(form.long_description)</textarea>

      @input!(ctx.1, default_license (text), "Default article license", form, errors, "minlenght=\"1\"")

      <input type="submit" value="@i18n!(ctx.1, "Save these settings")"/>
  </form>

  <h2>@i18n!(ctx.1, "Custom themes")</h2>
  <p>@i18n!(ctx.1, "These themes are used on blogs from other instance. They may contain tracking code, so you need to review and approve them.")</p>
  <p>@i18n!(ctx.1, "Once a theme is approved, people on your instance will be able to use it on their own blogs too.")</p>
  <p>@i18n!(ctx.1, "You can also upload your own themes if you have a command-line access to your instance.")</p>
  @if themes.read().unwrap().is_empty() {
      <p class="center">@i18n!(ctx.1, "There are no themes awaiting your approval for the moment.")</p>
  } else {
    <div class="cards">
      @for theme in themes.read().unwrap().clone() {
        <div class="card">
          <b>@theme.name</b>
          <p>@i18n!(ctx.1, "Files to review:")</p>
          <ul>
            @for url in theme.urls {
              <li><a href="@url">@url</a></li>
            }
          </ul>
          <footer>
            <form class="inline" method="post" action="@uri!(instance::reject_theme: name = &theme.name)">
                <input class="destructive" type="submit" value="@i18n!(ctx.1, "Reject")">
            </form>
            &mdash;
            <form class="inline" method="post" action="@uri!(instance::approve_theme: name = &theme.name)">
                <input type="submit" value="@i18n!(ctx.1, "Approve")">
            </form>
          </footer>
        </div>
      }
    </div>
  }
})
